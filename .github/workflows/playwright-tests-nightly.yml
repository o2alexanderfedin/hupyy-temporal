name: Playwright E2E Tests (Full Suite)

on:
  schedule:
    - cron: '0 2 * * *'  # 2 AM daily
  workflow_dispatch:  # Manual trigger

jobs:
  playwright-tests-full:
    name: Run Full E2E Test Suite
    runs-on: ubuntu-latest
    timeout-minutes: 90

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Install Playwright browsers
        run: |
          python -m playwright install chromium --with-deps

      - name: Setup CVC5 solver
        run: |
          # Download CVC5 binary
          wget https://github.com/cvc5/cvc5/releases/download/cvc5-1.3.1/cvc5-Linux-static.zip
          unzip cvc5-Linux-static.zip
          chmod +x cvc5-Linux-static/bin/cvc5
          sudo mv cvc5-Linux-static/bin/cvc5 /usr/local/bin/
          cvc5 --version

      - name: Start Streamlit app
        run: |
          nohup streamlit run demo/app.py \
            --server.port=8501 \
            --server.headless=true \
            --server.runOnSave=false \
            --server.fileWatcherType=none \
            --browser.gatherUsageStats=false \
            > streamlit.log 2>&1 &
          echo $! > streamlit.pid
          sleep 15  # Wait for app to start

      - name: Wait for Streamlit to be ready
        run: |
          timeout 60 bash -c 'until curl -s http://localhost:8501/_stcore/health > /dev/null; do sleep 2; done' || true
          echo "Streamlit should be running on port 8501"
          curl -s http://localhost:8501/_stcore/health || echo "Health check endpoint not available, continuing anyway"

      - name: Run ALL Playwright tests (including slow)
        run: |
          pytest tests/e2e/ \
            -v \
            --browser=chromium \
            --tracing=on \
            --video=on \
            --html=test-results/report.html \
            --self-contained-html \
            --maxfail=20
        env:
          CI: true
          # Add Claude API key if needed for full tests
          # ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-test-results-full
          path: test-results/
          retention-days: 30

      - name: Upload failure screenshots
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-screenshots-full
          path: test-results/screenshots/
          retention-days: 14

      - name: Upload failure videos
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-videos-full
          path: test-results/**/*.webm
          retention-days: 14

      - name: Upload traces
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-traces
          path: test-results/**/*.zip
          retention-days: 14

      - name: Upload Streamlit logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: streamlit-logs-full
          path: streamlit.log
          retention-days: 14

      - name: Cleanup
        if: always()
        run: |
          if [ -f streamlit.pid ]; then
            kill $(cat streamlit.pid) || true
          fi
          # Kill any remaining streamlit processes
          pkill -f streamlit || true
